---
repo: ctxify
type: domain
domain: validation
---

# validation

Validates two orthogonal concerns: (1) YAML config structure (ctx.yaml parsing and schema compliance) and (2) markdown shard structural integrity (frontmatter, segment markers, file existence). Config validation is strict (throws on unknown fields or type mismatches); shard validation is lenient (warns on TODOs, errors on unclosed markers). Both use pure validators; no side effects.

## Concepts

**Config validation**: YAML must have `version`, `workspace`, `mode` (single/multi/mono-repo), `repos[]` array, optional `monoRepo` object, optional `skills` object. Each repo must have `path` and `name`, optional `language`, `framework`. Relationships optional: must have `from`, `to`, valid `type`. Strict typing: missing fields throw `ConfigError`, unknown fields silently ignored (backward compat). **Shard validation**: index.md must exist, valid frontmatter, no unclosed segment markers (domain-index, correction, antipattern, rule, question, endpoint, type, env, model). Domain files must be registered in overview.md domain-index block or listed as `- {domain}.md`. **TODO warnings**: non-empty files with `<!-- TODO:` markers are warnings, not errors. **Segment marker stripping**: validates segment balance before stripping TODOs, so examples inside TODOs don't trigger false errors.

## Decisions

**Separate config and shard validation.** Config is YAML; shards are markdown. Different parsers, different concerns. Config validation is strict (required fields, type checks). Shard validation is structural (markers, frontmatter) not semantic (no checking that domain description is adequate). **Strict config, lenient shards.** Config is auto-generated by init; unknown fields are bugs. Shards are agent-filled; TODO markers are expected progress indicators, not errors. **Regex for segment matching with optional attributes.** Segments support colon-delimited attributes (e.g., HTML comment `endpoint:POST:/users`). Extraction uses regex with optional filter: `extractSegments(content, 'endpoint', { index: 0, value: 'POST', exact: true })`. Flexible for future segment use. **TODO blocks stripped during segment validation.** Agents write example markers inside TODO blocks. Validation strips TODOs first so examples don't trigger false balance errors.

## Patterns

**Config validation cascade**: `validateConfig()` calls field-specific validators (validateMode, validateRepos, validateRelationships, etc.). Each validator throws `ConfigError` on invalid data. Example: `validateRepos()` iterates repos array, checks type constraints, returns typed array. Validator functions are pure, testable. **Shard validation two-pass**: first pass collects .md files recursively, checks frontmatter, validates segment markers. Second pass counts TODOs and warns. Separate concerns. **Segment extraction with regex filter**: `extractSegments(content, 'endpoint', { index: 0, value: 'POST' })` returns all segment bodies where attribute 0 contains 'POST'. Exact match optional. Used by agents to request specific endpoint definitions without reading entire file.

## Cross-repo

`ctxify validate` reads all repos under `.ctxify/repos/` and validates each overview.md, patterns.md, domain files. Relationships are validated in ctx.yaml: `from` and `to` must refer to repo names in `repos[]` array. No cross-repo shard validation (e.g., checking that a domain referenced in one repo exists in another).
