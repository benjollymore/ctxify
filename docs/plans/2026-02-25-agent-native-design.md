# Agent-Native ctxify Design

## Vision

ctxify becomes a scaffolder + validator. The calling agent (e.g., Claude Code) does all semantic analysis. ctxify handles what's mechanical and deterministic; the agent handles what requires understanding code.

Output format stays the same: markdown shards with YAML frontmatter and HTML comment segment markers — proven LLM context optimization.

## Constraints

- All repos must be subdirectories of the workspace root
- ctxify must run from the workspace root
- Claude Code is the initial target agent; other agents can be supported later

## CLI Surface

| Command | Purpose |
|---------|---------|
| `ctxify init` | Detect repos, scaffold `.ctxify/`, write analysis checklist |
| `ctxify init --mono` | Monorepo mode (detect packages from workspace config) |
| `ctxify init --repos ./a ./b` | Multi-repo mode (explicit repo paths) |
| `ctxify validate` | Check shard structural integrity |
| `ctxify status` | Report what's filled vs pending |
| `ctxify branch <name>` | Create branch across all repos (multi-repo) |
| `ctxify commit <msg>` | Commit across all repos with changes (multi-repo) |

## What `ctxify init` Does

### Step 1: Workspace detection (mechanical)

- **No args**: single repo (current dir)
- **`--mono`**: parse workspace config from manifest (`workspaces` in package.json, `[workspace]` in Cargo.toml, pnpm-workspace.yaml) to find member packages
- **`--repos ./a ./b`**: multi-repo with explicit paths
- For each repo: parse manifest for name, language, dependencies, devDependencies, scripts, entry points. List key directories. Count files. Get git HEAD SHA.

### Step 2: Scaffold `.ctxify/`

Create directory structure and template files pre-filled with mechanical data:

- `index.md` — frontmatter with metadata + totals (zeros for agent-filled sections), repo table with deps/language/framework
- `repos/{name}.md` — heading, deps, scripts, structure filled; empty sections for narrative, conventions, role description
- `endpoints/{name}.md` — headers + frontmatter, segment markers ready, content marked TODO
- `types/shared.md` — headers, empty
- `env/all.md` — headers, empty
- `topology/graph.md` — repo list filled, relationships empty
- `schemas/{name}.md` — headers, empty
- `questions/pending.md` — headers, empty

### Step 3: Write `_analysis.md`

Generated checklist specific to this workspace. Contains mechanical data already extracted and semantic questions the agent needs to answer, with specific prompts per shard pointing at the right directories and files.

## What Gets Removed

- `src/passes/` — all 7 semantic regex passes (endpoint-scan, type-sharing, env-scan, relationship-inference, convention-scan, schema-scan, question-gen)
- `src/core/pipeline.ts` — pass orchestrator/DAG runner
- `src/core/differ.ts` — scan diffing
- `src/core/cache.ts` — pass result caching
- `src/cli/commands/query.ts` — agents read files directly
- `src/cli/commands/scan.ts` — replaced by init
- `src/renderers/` — all 8 renderers (templates replace generated prose)

## What Stays

- `src/core/config.ts` — reads ctx.yaml
- `src/core/context.ts` — WorkspaceContext types (templates need the shape)
- `src/utils/git.ts` — isGitRepo, getHeadSha, findGitRoots, getTrackedFiles, getDiff
- `src/utils/git-mutate.ts` — createBranch, hasChanges, stageAndCommit, getCurrentBranch
- `src/utils/yaml.ts` — config parsing, frontmatter
- `src/utils/frontmatter.ts` — used by validate
- `src/utils/segments.ts` — used by validate
- `src/cli/commands/branch.ts` — multi-repo branch coordination
- `src/cli/commands/commit.ts` — multi-repo commit coordination
- `src/cli/commands/status.ts` — workspace status check

## What's New

- `src/cli/commands/validate.ts` — quality gate: valid frontmatter, well-formed segments, cross-references point to existing repos, no unfilled TODOs, totals match content
- `src/templates/` — template generators for each shard type. String-building functions that fill mechanical data and leave semantic sections as TODOs
- `src/core/manifest.ts` — consolidated manifest parser (extract deps, scripts, entry points from package.json, Cargo.toml, pyproject.toml)

## The Skill File

Lives at `.claude/skills/ctxify/SKILL.md`. Five sections:

1. **Detection** — check for `.ctxify/index.md`, decide if workspace is initialized
2. **First-time setup** — identify repos, pick init mode, run `ctxify init`, then follow `_analysis.md`
3. **Reading context** — progressive disclosure: index -> repo shards -> detail shards
4. **Filling shards** — per-shard guide for semantic analysis (what to look for, expected format, frontmatter fields, segment marker syntax)
5. **Updating** — incremental updates when code changes, run `ctxify validate` after

## The Analysis Checklist (`_analysis.md`)

Generated by `ctxify init`, specific to the workspace. Contains:

- Repos detected with mechanical data (language, framework, file count, entry points)
- Per-shard TODO checklist with specific prompts:
  - Endpoints: which dirs to check for route definitions
  - Shared types: find cross-repo type imports
  - Env vars: check .env files and code references
  - Relationships: how repos connect
  - Schemas: look for ORM definitions
  - Conventions: testing, linting, build patterns

## `ctxify validate` Checks

- All frontmatter is valid YAML
- Segment markers are well-formed (open/close pairs match)
- Cross-references point to repos that exist in config
- No empty TODO sections left unfilled
- Totals in index.md frontmatter match actual content counts

## Shard Format (unchanged)

Markdown with YAML frontmatter and HTML comment segment markers:

```markdown
---
ctxify: "2.0"
scanned_at: "2026-02-25T10:00:00Z"
totals:
  repos: 2
  endpoints: 3
---

# Workspace: my-project

Prose content...

<!-- endpoint:GET:/users -->
**GET /users** -- `src/routes/users.ts:5` (getUsers)
<!-- /endpoint -->
```

Frontmatter is frontloaded for fast agent parsing. Segments enable targeted extraction without reading entire files.
